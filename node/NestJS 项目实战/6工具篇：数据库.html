<!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title></title>
    </head>
    <body>
    <div class="markdown-body"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre>code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote>p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre>code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">å‰è¨€</h2>
<p>åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡æ¥å…¥é£ä¹¦åº”ç”¨ä»¥åŠæœºå™¨äººæ¶ˆæ¯æ¨é€ï¼Œå¯¹ä½¿ç”¨ <code>NestJS</code> æ¡†æ¶ä»¥åŠåç«¯ä¸šåŠ¡å¼€å‘æœ‰äº†ä¸€å®šçš„ç»éªŒï¼Œä¹Ÿå¼€å¯äº†æ­£å¼å¼€å‘çš„ç¬¬ä¸€æ­¥ã€‚</p>
<p>åœ¨ä¸€ä¸ªæ™®é€šçš„åç«¯ä¸šåŠ¡å¼€å‘ä¸­åŸºæœ¬ä¸Šé€ƒç¦»ä¸äº† <strong>CURD</strong>ï¼Œä¹Ÿå°±æ˜¯å¯¹æ•°æ®çš„å¸¸è§„æ“ä½œã€‚åœ¨æŠ€æœ¯é€‰å‹ä¸­æåˆ°ï¼Œç½‘å…³ç³»ç»Ÿä¸­å°†åŒæ—¶ä½¿ç”¨ <strong>2</strong> ç§æ•°æ®åº“ <code>MySQL</code> ä¸ <code>MongoDB</code>ï¼ˆåˆ†åˆ«æ˜¯å…³ç³»å‹æ•°æ®åº“ä¸éå…³ç³»æ•°æ®åº“çš„ä»£è¡¨ï¼‰åˆ†åˆ«è¿›è¡Œç”¨æˆ·ä¸ç‰©æ–™æœåŠ¡çš„æ•°æ®å­˜å‚¨ã€‚</p>
<p>ä½œä¸ºåŸºç¡€è„šæ‰‹æ¶çš„æ­å»ºï¼Œä¸ºäº†ä¾¿äºä¸šåŠ¡å¼€å‘åŒå­¦çš„ä½¿ç”¨ä¸å¼€å‘ä½“éªŒï¼Œæ¯”è¾ƒå¥½çš„æ–¹å¼æ˜¯ä½¿ç”¨é…ç½®æ¨¡å¼æä¾›ç»Ÿä¸€çš„ <strong>API</strong> è°ƒç”¨å‡å°‘å¼€å‘çš„ç†è§£ä¸æ¥å…¥æˆæœ¬ã€‚</p>
<p>æœ¬ç« æˆ‘ä»¬å°†å­¦ä¹ å¯¹æ•°æ®åº“çš„å°è£…ä»¥åŠå¸¸è§„çš„æ•°æ®åº“æ“ä½œã€‚</p>
<h2 data-id="heading-1">TypeORM</h2>
<p>æ—¥å¸¸å¯¹æ•°æ®åº“çš„æ“ä½œéœ€è¦å€ŸåŠ©äº <code>SQL</code>ï¼Œè‡³å°‘éœ€è¦æŒæ¡åŸºç¡€çš„ <code>SQL</code> è¯­æ³•å°±æœ‰å»ºè¡¨ã€å¢åˆ æ”¹æŸ¥ç­‰ã€‚ä½†å¦‚æœæƒ³è¦åœ¨ä»£ç ä¸­ç›´æ¥å®ç°å¯¹æ•°æ®åº“çš„æ“ä½œï¼Œå°±éœ€è¦å»å†™å¤§é‡ <code>SQL</code> ï¼Œè¿™åœ¨<strong>å¯è¯»æ€§ã€ç»´æŠ¤æ€§ã€å¼€å‘ä½“éªŒä»¥åŠç»´æŠ¤ä¸Šéƒ½æ˜¯éå¸¸ç³Ÿç³•çš„</strong>ã€‚</p>
<p>æ‰€ä»¥ <strong>ORM</strong> æ¡†æ¶ä¹Ÿå°±åº”è¿è€Œç”Ÿï¼Œè¿™ä¸€ç±»çš„æ¡†æ¶æ˜¯ä¸ºäº†è§£å†³é¢å‹å¯¹è±¡ä¸å…³ç³»æ•°æ®åº“å­˜åœ¨çš„äº’ä¸åŒ¹é…çš„ç°è±¡ï¼ŒæŠŠé¢å‘ <code>SQL</code> å¼€å‘è½¬å˜ä¸ºé¢å‘å¯¹è±¡å¼€å‘ï¼Œå¼€å‘ä¸éœ€è¦å…³æ³¨åº•å±‚å®ç°ç»†èŠ‚ï¼Œå¯ä»¥ä»¥æ“ä½œå¯¹è±¡çš„æ¨¡å¼ä½¿ç”¨æ•°æ®åº“ã€‚</p>
<blockquote>
<p>å¯¹è±¡å…³ç³»æ˜ å°„ï¼ˆObject Relational Mappingï¼Œç®€ç§° ORMï¼‰æ¨¡å¼æ˜¯ä¸€ç§ä¸ºäº†è§£å†³é¢å‘å¯¹è±¡ä¸å…³ç³»æ•°æ®åº“å­˜åœ¨çš„äº’ä¸åŒ¹é…ç°è±¡çš„æŠ€æœ¯ã€‚</p>
</blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftypeorm%2Ftypeorm" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/typeorm/typeorm" ref="nofollow noopener noreferrer">TypeORM</a>&nbsp;ä½œä¸º <code>Node.js</code> ä¸­è€ç‰Œçš„ <code>ORM</code> æ¡†æ¶ï¼Œæ— è®ºæ˜¯æ¥å£å®šä¹‰ï¼Œè¿˜æ˜¯ä»£ç å®ç°æ–¹é¢éƒ½ç®€å•æ˜“æ‡‚ã€å¯è¯»æ€§é«˜ï¼Œä¹Ÿå¾ˆå®¹æ˜“å¯¹æ¥å¤šç§æ•°æ®æºã€‚</p>
<p>è™½ç„¶å¸‚é¢ä¸Šä¹Ÿæœ‰å…¶ä»–ä¸é”™çš„ <code>ORM</code> æ¡†æ¶ï¼Œæ¯”å¦‚ <a href="https://link.juejin.cn?target=https%3A%2F%2Fsequelize.org%2F" target="_blank" rel="nofollow noopener noreferrer" title="https://sequelize.org/" ref="nofollow noopener noreferrer">Sequelize</a>ã€<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.prisma.io%2F" target="_blank" rel="nofollow noopener noreferrer" title="https://www.prisma.io/" ref="nofollow noopener noreferrer">Prisma</a> ç­‰ï¼Œä½† <code>TypeORM</code> ä½¿ç”¨&nbsp;<code>TypeScript</code>&nbsp;ç¼–å†™ï¼Œåœ¨&nbsp;<code>NestJS</code>&nbsp;æ¡†æ¶ä¸‹è¿è¡Œå¾—éå¸¸å¥½ï¼Œä¹Ÿæ˜¯ <code>NestJS</code> é¦–æ¨çš„ <code>ORM</code> æ¡†æ¶ï¼Œæœ‰å¼€ç®±å³ç”¨çš„&nbsp;<code>@nestjs/typeorm</code>&nbsp;è½¯ä»¶åŒ…æ”¯æŒã€‚</p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬çš„ <code>ORM</code> æ¡†æ¶ä¹Ÿå°†é€‰ç”¨ <code>TypeORM</code> æ¥å¼€å‘ï¼ˆçœ‹ä¸ªäººå–œå¥½ä¸éœ€æ±‚ï¼Œå¦‚æœå–œæ¬¢ <strong>GraphQL</strong> çš„ï¼Œä½¿ç”¨ <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.prisma.io%2F" target="_blank" rel="nofollow noopener noreferrer" title="https://www.prisma.io/" ref="nofollow noopener noreferrer">Prisma</a> æ›´å¥½ï¼‰ã€‚</p>
<h4 data-id="heading-2">å°è£…</h4>
<p><code>NestJS</code> ä½¿ç”¨ <code>TypeORM</code> çš„æ–¹å¼æœ‰ä¸¤ç§ã€‚ä¸€ç§æ˜¯ <code>NestJS</code> æä¾›çš„ <code>@nestjs/typeorm</code> é›†æˆåŒ…ï¼Œå¯ä»¥å¯¼å‡º <code>TypeOrmModule.forRoot</code> æ–¹æ³•æ¥è¿æ¥æ•°æ®åº“ï¼ŒåŒæ—¶å¯ä»¥ä½¿ç”¨ <code>ormconfig.json</code> å°†æ•°æ®åº“é“¾æ¥é…ç½®é¡¹å‰¥ç¦»ã€‚å¦å¤–ä¸€ç§æ˜¯ç›´æ¥ä½¿ç”¨ <code>typeorm</code>ï¼Œè‡ªç”±å°è£… <code>Providers</code> å¯¼å…¥ä½¿ç”¨ã€‚</p>
<p>ä¸¤ç§æ–¹æ¡ˆå„æœ‰ä¼˜ç¼ºç‚¹ï¼Œä½¿ç”¨ <code>@nestjs/typeorm</code> é›†æˆçš„æ–¹æ¡ˆè¾ƒä¸ºç®€ä¾¿ï¼Œä½†è‡ªå»ºçš„ä¸šåŠ¡è„šæ‰‹æ¶éœ€è¦ä¸¤ç§æ•°æ®åº“ä¿è¯åœ¨å¼€å‘ä¸­ä½“éªŒä¸€è‡´æ€§ï¼Œæ­¤å¤–ä¹‹å‰å·²ç»è‡ªå®šä¹‰äº†å…¨å±€ç¯å¢ƒå˜é‡çš„é…ç½®ï¼Œæ²¡æœ‰å¿…è¦å†å¤šä¸€ä¸ª <code>ormconfig.json</code> çš„é…ç½®æ¥å¢åŠ é¢å¤–ç†è§£æˆæœ¬ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä½¿ç”¨ç¬¬äºŒç§æ–¹æ¡ˆæ¥è¿æ¥æ•°æ®åº“ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥</strong>ï¼šè·Ÿä¹‹å‰ä¸€æ ·ï¼Œä¸ºäº†ä½¿ç”¨ <code>TypeORM</code>ï¼Œå…ˆå®‰è£…ä»¥ä¸‹ä¾èµ–ã€‚</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$ </span><span class="bash">yarn add typeorm mysql2 mongoose</span>
</code></pre>
<p><strong>ç¬¬äºŒæ­¥</strong>ï¼šåœ¨ <code>dev.yaml</code> ä¸­æ·»åŠ æ•°æ®åº“é…ç½®å‚æ•°ã€‚</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">MONGODB_CONFIG:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">"fast_gateway_test"</span>          <span class="hljs-comment"># è‡ªå®šä¹‰æ¬¡æ•°æ®åº“é“¾æ¥åç§°</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">mongodb</span>                      <span class="hljs-comment"># æ•°æ®åº“é“¾æ¥ç±»å‹</span>
  <span class="hljs-attr">url:</span> <span class="hljs-string">"mongodb://localhost:27017"</span>   <span class="hljs-comment"># æ•°æ®åº“é“¾æ¥åœ°å€</span>
  <span class="hljs-attr">username:</span> <span class="hljs-string">"xxxx"</span>                   <span class="hljs-comment"># æ•°æ®åº“é“¾æ¥ç”¨æˆ·å</span>
  <span class="hljs-attr">password:</span> <span class="hljs-string">"123456"</span>                 <span class="hljs-comment"># æ•°æ®åº“é“¾æ¥å¯†ç </span>
  <span class="hljs-attr">database:</span> <span class="hljs-string">"fast_gateway_test"</span>      <span class="hljs-comment"># æ•°æ®åº“å</span>
  <span class="hljs-attr">entities:</span> <span class="hljs-string">"mongo"</span>                  <span class="hljs-comment"># è‡ªå®šä¹‰åŠ è½½ç±»å‹</span>
  <span class="hljs-attr">logging:</span> <span class="hljs-literal">false</span>                     <span class="hljs-comment"># æ•°æ®åº“æ‰“å°æ—¥å¿—</span>
  <span class="hljs-attr">synchronize:</span> <span class="hljs-literal">true</span>                  <span class="hljs-comment"># æ˜¯å¦å¼€å¯åŒæ­¥æ•°æ®è¡¨åŠŸèƒ½</span>
</code></pre>
<p>ä»¥ä¸Šæ˜¯æ•°æ®åº“è¿æ¥çš„å¿…è¦å‚æ•°ï¼Œå…¶ä»–çš„å‚æ•°å¯ä»¥<a href="https://link.juejin.cn?target=https%3A%2F%2Ftypeorm.io%2Fdata-source-options" target="_blank" rel="nofollow noopener noreferrer" title="https://typeorm.io/data-source-options" ref="nofollow noopener noreferrer">å‚è€ƒæ–‡æ¡£</a>æ ¹æ®éœ€æ±‚æ·»åŠ ï¼Œä¾‹å¦‚ <code>retryAttempts</code>ï¼ˆé‡è¯•è¿æ¥æ•°æ®åº“çš„æ¬¡æ•°ï¼‰ã€<code>keepConnectionAlive</code>ï¼ˆåº”ç”¨ç¨‹åºå…³é—­åè¿æ¥æ˜¯å¦å…³é—­ï¼‰ ç­‰é…ç½®é¡¹ã€‚</p>
<p><strong>ç¬¬ä¸‰æ­¥</strong>ï¼šæ–°å»º <code>src/common/database/database.providers.ts</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">DataSource</span>, <span class="hljs-title class_">DataSourceOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'typeorm'</span>;
<span class="hljs-keyword">import</span> { getConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/utils/index'</span>
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

<span class="hljs-comment">// è®¾ç½®æ•°æ®åº“ç±»å‹</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">databaseType</span>: <span class="hljs-title class_">DataSourceOptions</span>[<span class="hljs-string">'type'</span>] = <span class="hljs-string">'mongodb'</span>;
<span class="hljs-keyword">const</span> { <span class="hljs-variable constant_">MONGODB_CONFIG</span> } = <span class="hljs-title function_">getConfig</span>()

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MONGODB_DATABASE_CONFIG</span> = {
  ...<span class="hljs-variable constant_">MONGODB_CONFIG</span>,
  <span class="hljs-attr">type</span>: databaseType,
  <span class="hljs-attr">entities</span>: [path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">`../../**/*.<span class="hljs-subst">${MONGODB_CONFIG.entities}</span>.entity{.ts,.js}`</span>)],
}

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MONGODB_DATA_SOURCE</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSource</span>(<span class="hljs-variable constant_">MONGODB_DATABASE_CONFIG</span>)

<span class="hljs-comment">// æ•°æ®åº“æ³¨å…¥</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">DatabaseProviders</span> = [
  {
    <span class="hljs-attr">provide</span>: <span class="hljs-string">'MONGODB_DATA_SOURCE'</span>,
    <span class="hljs-attr">useFactory</span>: <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">MONGODB_DATA_SOURCE</span>.<span class="hljs-title function_">initialize</span>()
      <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">MONGODB_DATA_SOURCE</span>
    }
  }
];
</code></pre>
<p><strong>ç¬¬å››æ­¥</strong>ï¼šæ–°å»º <code>database.module.ts</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DatabaseProviders</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./database.providers'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">providers</span>: [...<span class="hljs-title class_">DatabaseProviders</span>],
  <span class="hljs-attr">exports</span>: [...<span class="hljs-title class_">DatabaseProviders</span>],
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseModule</span> { }
</code></pre>
<p>è‡³æ­¤æˆ‘ä»¬å·²ç»å°è£…äº† <code>MongoDB</code> çš„ <code>Provider</code>ï¼Œå¦‚æœéœ€è¦å¼•å…¥ <code>Mysql</code> æˆ–è€…å…¶ä»–ç±»å‹æ•°æ®åº“çš„è¯ï¼Œåªéœ€è¦æ›¿æ¢å¯¹åº”çš„é…ç½®å‚æ•°ï¼Œé‡å¤ä¸Šè¿°æ­¥éª¤å³å¯ã€‚</p>
<blockquote>
<p>åœ¨æˆ‘å†™è¿™ä¸ªå°å†Œçš„æ—¶å€™ï¼Œç”¨çš„ <code>TypeORM</code> ç‰ˆæœ¬æ˜¯ <code>0.3.5+ï¼Œ</code>è€Œ <code>0.3.5+</code> çš„ä¸­è‹±æ–‡æ–‡æ¡£æ˜¯ä¸åŒæ­¥çš„ï¼Œä¸­æ–‡æ–‡æ¡£æ˜¯ <code>0.2.37+</code> çš„ç‰ˆæœ¬ï¼Œå¦‚æœä½ å‡ºç°å¼€å‘è¿‡ç¨‹ä¸­å‘ç°ä¸€äº›å…¼å®¹çš„é—®é¢˜ï¼Œæ­¤æ—¶ä¸­æ–‡æ–‡æ¡£æ˜¯å¯¹åº”ä¸ä¸Šçš„ï¼Œéœ€è¦æŸ¥çœ‹<a href="https://link.juejin.cn?target=https%3A%2F%2Ftypeorm.io%2F" target="_blank" rel="nofollow noopener noreferrer" title="https://typeorm.io/" ref="nofollow noopener noreferrer">è‹±æ–‡æ–‡æ¡£</a>ã€‚</p>
</blockquote>
<h4 data-id="heading-3">ä½¿ç”¨</h4>
<p><strong>ç¬¬ä¸€æ­¥</strong>ï¼šæ³¨å†Œå®ä½“ï¼Œåˆ›å»º <code>src/user/user.mongo.entity.ts</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Entity</span>, <span class="hljs-title class_">Column</span>, <span class="hljs-title class_">UpdateDateColumn</span>, <span class="hljs-title class_">ObjectIdColumn</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'typeorm'</span>;

<span class="hljs-meta">@Entity</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-meta">@ObjectIdColumn</span>()
  id?: <span class="hljs-built_in">number</span>;

  <span class="hljs-meta">@Column</span>({ <span class="hljs-attr">default</span>: <span class="hljs-literal">null</span> })
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p>åœ¨ <code>MongoDB</code> é‡Œé¢ä½¿ç”¨çš„æ˜¯ <code>ObjectIdColumn</code> ä½œä¸ºç±»ä¼¼ <code>Mysql</code> çš„è‡ªå¢ä¸»é”®ï¼Œæ¥ä¿è¯æ•°æ®å”¯ä¸€æ€§ï¼Œåªæ˜¯ç±»ä¼¼ï¼Œå¹¶ä¸æ˜¯è·Ÿæ™®é€šè‡ªå¢ä¸»é”®ä¸€æ ·ä¼šé€’å¢ï¼ŒæŠŠå®ƒçœ‹æˆ <code>uuid</code> ç±»ä¼¼å³å¯ã€‚</p>
<p>æ­¤å¤–åº”è¯¥æ³¨æ„æˆ‘ä»¬åˆ›å»ºçš„å®ä½“ç±»æ–‡ä»¶å‘½ååç¼€ä¸º <code>entity.ts</code>ï¼Œè€Œåœ¨ä¸Šæ–‡æ•°æ®åº“è¿æ¥çš„é…ç½®ä¸­æœ‰ä¸€ä¸ª <code>entities</code> å‚æ•°ï¼š</p>
<pre><code class="hljs language-css" lang="css">entities:[path.<span class="hljs-built_in">join</span>(__dirname, `../..<span class="hljs-comment">/**/</span>*.${MONGODB_CONFIG<span class="hljs-selector-class">.entities</span>}<span class="hljs-selector-class">.entity</span>{<span class="hljs-selector-class">.ts</span>,<span class="hljs-selector-class">.js</span>}`)]
</code></pre>
<p>è¿™ä¸ªå±æ€§é…ç½®ä»£è¡¨ï¼šåªè¦æ˜¯ä»¥ <code>entity.ts</code> ç»“å°¾çš„å®ä¾‹ç±»ï¼Œéƒ½ä¼šè¢«è‡ªåŠ¨æ‰«æè¯†åˆ«ï¼Œå¹¶åœ¨æ•°æ®åº“ä¸­ç”Ÿæˆå¯¹åº”çš„å®ä½“è¡¨ã€‚</p>
<p>æ‰€ä»¥æƒ³ä½¿ç”¨ <code>Mysql</code> åˆåŒæ—¶æƒ³ä½¿ç”¨è‡ªåŠ¨æ³¨å†Œè¿™ä¸ªåŠŸèƒ½çš„è¯ï¼Œä¸€å®šè¦åŒºåˆ†åç¼€åï¼Œä¸ç„¶ä¼šå‡ºç°æ··ä¹±æ³¨å†Œçš„æƒ…å†µï¼Œ<code>mysql</code> çš„é…ç½®ä¾‹å¦‚ä¸‹é¢æ‰€ç¤ºï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">MYSQL_CONFIG:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">"user-test"</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">"mysql"</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">"localhost"</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">3306</span>
  <span class="hljs-attr">username:</span> <span class="hljs-string">"xxxx"</span>
  <span class="hljs-attr">password:</span> <span class="hljs-string">"123456"</span>
  <span class="hljs-attr">database:</span> <span class="hljs-string">"user-test"</span>
  <span class="hljs-attr">entities:</span> <span class="hljs-string">"mysql"</span> <span class="hljs-comment"># è¿™é‡Œçš„å‘½åä¸€å®šè¦è·Ÿ MongoDB é‡Œé¢çš„é…ç½®å‘½ååŒºåˆ†å¼€</span>
  <span class="hljs-attr">synchronize:</span> <span class="hljs-literal">true</span>
</code></pre>
<blockquote>
<p>MongoDB æ˜¯æ— æ¨¡å¼çš„ï¼Œæ‰€ä»¥å³ä½¿åœ¨é…ç½®å‚æ•°å¼€å¯äº† <code>synchronize</code>ï¼Œå¯åŠ¨é¡¹ç›®çš„æ—¶å€™ä¹Ÿä¸ä¼šå»æ•°æ®åº“åˆ›å»ºå¯¹åº”çš„è¡¨ï¼Œæ‰€ä»¥ä¸ç”¨å¥‡æ€ªï¼Œå¹¶æ²¡æœ‰å‡ºé”™ï¼Œä½† <code>Mysql</code> åœ¨æ¯æ¬¡åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨åŒæ­¥è¡¨ç»“æ„ï¼Œå®¹æ˜“é€ æˆæ•°æ®ä¸¢å¤±ï¼Œç”Ÿäº§ç¯å¢ƒè®°å¾—å…³é—­ï¼Œä»¥å…é€ æˆæ— å¯é¢„è®¡çš„æŸå¤±ã€‚</p>
</blockquote>
<p><strong>ç¬¬äºŒæ­¥</strong>ï¼šåˆ›å»º <code>user.providers.ts</code>ï¼š</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.mongo.entity'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserProviders</span> = [
  {
    <span class="hljs-attr">provide</span>: <span class="hljs-string">'USER_REPOSITORY'</span>,
    <span class="hljs-attr">useFactory</span>: <span class="hljs-keyword">async</span> (<span class="hljs-title class_">AppDataSource</span>) =&gt; <span class="hljs-keyword">await</span> <span class="hljs-title class_">AppDataSource</span>.<span class="hljs-title function_">getRepository</span>(<span class="hljs-title class_">User</span>),
    <span class="hljs-attr">inject</span>: [<span class="hljs-string">'MONGODB_DATA_SOURCE'</span>],
  },
];
</code></pre>
<p><strong>ç¬¬ä¸‰æ­¥</strong>ï¼šåˆ›å»º <code>user.service.ts</code>ï¼Œæ–°å¢æ·»åŠ ç”¨æˆ· <code>service</code>ï¼š</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">In</span>, <span class="hljs-title class_">Like</span>, <span class="hljs-title class_">Raw</span>, <span class="hljs-title class_">MongoRepository</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'typeorm'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">Inject</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.mongo.entity'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-meta">@Inject</span>(<span class="hljs-string">'USER_REPOSITORY'</span>)
    <span class="hljs-keyword">private</span> userRepository: MongoRepository&lt;User&gt;
  </span>) { }

  <span class="hljs-title function_">createOrSave</span>(<span class="hljs-params">user</span>) {
   <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">save</span>(user)
  }
}
</code></pre>
<p><strong>ç¬¬å››æ­¥</strong>ï¼šåˆ›å»º <code>user.controller.ts</code>ï¼Œæ·»åŠ æ–°å¢ç”¨æˆ·çš„ <code>http</code> è¯·æ±‚æ–¹æ³•:</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Post</span>, <span class="hljs-title class_">Body</span>, <span class="hljs-title class_">Query</span>, <span class="hljs-title class_">Get</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AddUserDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.dto'</span>;

<span class="hljs-meta">@ApiTags</span>(<span class="hljs-string">'ç”¨æˆ·'</span>)
<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'user'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> userService: UserService,
  </span>) { }

  <span class="hljs-meta">@ApiOperation</span>({
    <span class="hljs-attr">summary</span>: <span class="hljs-string">'æ–°å¢ç”¨æˆ·'</span>,
  })
  <span class="hljs-meta">@Post</span>(<span class="hljs-string">'/add'</span>)
  <span class="hljs-title function_">create</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>() user: AddUserDto</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">createOrSave</span>(user);
  }
}
</code></pre>
<p><code>user.dto.ts</code> çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ApiProperty</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/swagger'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">IsNotEmpty</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'class-validator'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddUserDto</span> {
  <span class="hljs-meta">@ApiProperty</span>({ <span class="hljs-attr">example</span>: <span class="hljs-number">123</span>, })
  id?: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@ApiProperty</span>({ <span class="hljs-attr">example</span>: <span class="hljs-string">'cookie'</span> })
  <span class="hljs-meta">@IsNotEmpty</span>()
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@ApiProperty</span>({ <span class="hljs-attr">example</span>: <span class="hljs-string">'cookieboty@qq.com'</span> })
  <span class="hljs-meta">@IsNotEmpty</span>()
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@ApiProperty</span>({ <span class="hljs-attr">example</span>: <span class="hljs-string">'cookieboty'</span> })
  <span class="hljs-meta">@IsNotEmpty</span>()
  <span class="hljs-attr">username</span>: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p><strong>ç¬¬äº”æ­¥</strong>ï¼šåˆ›å»º <code>user.module.ts</code>ï¼Œå°† <code>controller</code>ã€<code>providers</code>ã€<code>service</code> ç­‰éƒ½å¼•å…¥åï¼Œ<strong>åˆ‡è®°</strong>å°† <code>user.module.ts</code> å¯¼å…¥ <code>app.module.ts</code> åæ‰ä¼šç”Ÿæ•ˆï¼Œè¿™ä¸€æ­¥åˆ«å¿˜è®°äº† :</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DatabaseModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/common/database/database.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.controller'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserProviders</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.providers'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FeishuController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./feishu/feishu.controller'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FeishuService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./feishu/feishu.service'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title class_">DatabaseModule</span>
  ],
  <span class="hljs-attr">controllers</span>: [
    <span class="hljs-title class_">FeishuController</span>,
    <span class="hljs-title class_">UserController</span>
  ],
  <span class="hljs-attr">providers</span>: [...<span class="hljs-title class_">UserProviders</span>, <span class="hljs-title class_">UserService</span>, <span class="hljs-title class_">FeishuService</span>],
  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">UserService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserModule</span> { }
</code></pre>
<p>å®Œæˆä¸Šè¿°æ‰€æœ‰æ­¥éª¤ä¹‹åï¼Œæ­¤æ—¶æ‰“å¼€ <code>Swagger</code> æ–‡æ¡£å¯ä»¥çœ‹åˆ°ï¼Œå·²ç»åˆ›å»ºå¥½äº† <code>/api/user/add</code> æ–°å¢ç”¨æˆ·çš„ <code>http</code> æ¥å£ï¼š</p>
<p><img src="p6-juejin.byteimg.comtos-cn-i-k3u1fbpfcp5a2ab7e0c5f1468f93b1fe3a445b51eb~tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp?" alt="image.png" loading="lazy" class="medium-zoom-image"></p>
<p>ç‚¹å‡»æµ‹è¯•èƒ½æ­£å¸¸å¾—åˆ°å¦‚ä¸‹è¿”å›å€¼çš„è¯ï¼Œåˆ™ä»£è¡¨æ•°æ®æ’å…¥æˆåŠŸï¼ŒåŠŸèƒ½æ­£å¸¸ï¼š</p>
<p><img src="p9-juejin.byteimg.comtos-cn-i-k3u1fbpfcp7f96c873a40a4c8da2c2a5570ae82945~tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp?" alt="image.png" loading="lazy" class="medium-zoom-image"></p>
<blockquote>
<p><code>MongoDB</code> çš„ç¤ºä¾‹ä»£ç å·²ä¸Šä¼  <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fboty-design%2Fgateway%2Ftree%2Fdemo%2Fv6" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/boty-design/gateway/tree/demo/v6" ref="nofollow noopener noreferrer">demo/v6</a>ï¼Œéœ€è¦çš„åŒå­¦è‡ªå–ã€‚</p>
</blockquote>
<h2 data-id="heading-4">Redis</h2>
<p>åœ¨æŠ€æœ¯é€‰å‹ä¸­ï¼Œæˆ‘ä»¬æåˆ°äº† <code>Redis</code> è™½ç„¶ä½œä¸ºæ•°æ®åº“ï¼Œä½†æ˜¯å¸¸è§çš„ç”¨æ³•æ˜¯ä½œä¸ºç»Ÿä¸€ã€é«˜é€Ÿç¼“å­˜æœåŠ¡æ¥ä½¿ç”¨ã€‚</p>
<p>åœ¨åŸºç¡€åŠŸèƒ½é…ç½®ä¸­ï¼Œä½¿ç”¨äº† <code>NestJS</code> è‡ªå¸¦çš„é«˜é€Ÿç¼“å­˜æ’ä»¶ <code>cache-manager</code> æ¥ç¼“å­˜é£ä¹¦çš„æ¥å£å‡­è¯ï¼Œ<code>cache-manager</code> é™¤äº†æä¾›æœ¬åœ°çš„é«˜é€Ÿç¼“å­˜ä¹‹å¤–ï¼Œä¹Ÿæä¾›äº†æ›¿æ¢åº•å±‚ç¼“å­˜æœåŠ¡çš„èƒ½åŠ›ã€‚</p>
<p>è·Ÿæˆ‘ä»¬ä¸Šæ–‡å°è£…çš„æ•°æ®åº“å·¥å…·ä¸€æ ·ï¼Œ<code>cache-manager</code> å°†åº•å±‚çš„å¤šç§ç¼“å­˜å¯¹æ¥é€»è¾‘è¿›è¡Œå°è£…ï¼Œå±è”½åº•å±‚æ¥å£çš„å·®å¼‚æ€§ï¼Œå¯¹å¤–åˆ™æä¾›äº†ä¸€è‡´çš„ <code>API</code> è°ƒç”¨ï¼Œå¯ä»¥å‡å°‘æ¥å…¥ä¸ç†è§£æˆæœ¬ï¼Œå¯¹äºå¼€å‘è€…æ¥è¯´å¯ä»¥å¾ˆæ–¹ä¾¿çš„æŠŠä¹‹å‰çš„ç¼“å­˜ç±»å‹ç”±æœ¬åœ°æ›¿æ¢æˆ <code>Redis</code>ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥</strong>ï¼šå®‰è£…å¯¹åº”çš„ <code>cache-manager-redis-store</code> ä¾èµ–</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$ </span><span class="bash">yarn add cache-manager-redis-store</span>
</code></pre>
<p><strong>ç¬¬äºŒæ­¥</strong>ï¼š<code>yaml</code> ä¸­æ–°å¢ <code>Redis</code> é…ç½®å‚æ•°ï¼š</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">REDIS_CONFIG:</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">"localhost"</span>  <span class="hljs-comment"># redis é“¾æ¥</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>         <span class="hljs-comment"># redis ç«¯å£</span>
  <span class="hljs-attr">auth:</span> <span class="hljs-string">"xxxx"</span>       <span class="hljs-comment"># redis è¿æ¥å¯†ç </span>
  <span class="hljs-attr">db:</span> <span class="hljs-number">1</span>              <span class="hljs-comment"># redis æ•°æ®åº“</span>
</code></pre>
<p><strong>ç¬¬ä¸‰æ­¥</strong>ï¼šæ”¹é€ ä¹‹å‰è·å–ç¯å¢ƒå˜é‡çš„æ–¹æ³•ï¼Œå¯ä»¥æ ¹æ®ä¼ å…¥çš„å˜é‡åè·å–å¯¹åº”çš„é…ç½®ï¼š</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getConfig</span> = (<span class="hljs-params"><span class="hljs-keyword">type</span>?: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> environment = <span class="hljs-title function_">getEnv</span>()
  <span class="hljs-keyword">const</span> yamlPath = path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">`./.config/.<span class="hljs-subst">${environment}</span>.yaml`</span>)
  <span class="hljs-keyword">const</span> file = fs.<span class="hljs-title function_">readFileSync</span>(yamlPath, <span class="hljs-string">'utf8'</span>)
  <span class="hljs-keyword">const</span> config = <span class="hljs-title function_">parse</span>(file)
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span>) {
    <span class="hljs-keyword">return</span> config[<span class="hljs-keyword">type</span>]
  }
  <span class="hljs-keyword">return</span> config
}
</code></pre>
<p><strong>ç¬¬å››æ­¥</strong>ï¼šä¿®æ”¹ <code>app.module.ts</code> ä¸­çš„ <code>CacheModule</code> åˆå§‹åŒ–é…ç½®ï¼š</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CacheModule</span>, <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user/user.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { getConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> redisStore <span class="hljs-keyword">from</span> <span class="hljs-string">'cache-manager-redis-store'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title class_">CacheModule</span>.<span class="hljs-title function_">register</span>({
      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">store</span>: redisStore,
      <span class="hljs-attr">host</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">host</span>,
      <span class="hljs-attr">port</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">port</span>,
      <span class="hljs-attr">auth_pass</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">auth</span>,
      <span class="hljs-attr">db</span>: <span class="hljs-title function_">getConfig</span>(<span class="hljs-string">'REDIS_CONFIG'</span>).<span class="hljs-property">db</span>
    }),
    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">ignoreEnvFile</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">load</span>: [getConfig]
    }), <span class="hljs-title class_">UserModule</span>],
  <span class="hljs-attr">controllers</span>: [],
  <span class="hljs-attr">providers</span>: [],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> { }
</code></pre>
<p>å®Œæˆä¸Šè¿°æ“ä½œä¹‹åï¼Œä¹‹å‰ä¸šåŠ¡è°ƒç”¨æ–¹æ³•ä¸éœ€è¦åšä»»ä½•é¢å¤–çš„æ”¹åŠ¨ï¼Œå°±å·²ç»å®Œæˆäº† <code>Redis</code> çš„æ¥å…¥ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨ä¹‹å‰çš„é£ä¹¦æ¶ˆæ¯æ¨é€çš„æ¥å£ï¼Œæ­£å¸¸è®¿é—®å¾—åˆ°å¦‚ä¸‹ç»“æœåˆ™ä»£è¡¨æ›¿æ¢å®Œæˆï¼š</p>
<p><img src="p9-juejin.byteimg.comtos-cn-i-k3u1fbpfcp750d0e0ef5314e828e0d0ae7fe3c9853~tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp?" alt="image.png" loading="lazy" class="medium-zoom-image"></p>
<p>å¦‚æœæƒ³è¦æŸ¥çœ‹ <code>Redis</code> çš„ç¼“å­˜æ•°æ®ï¼Œæ¯”è¾ƒç®€å•çš„æ–¹å¼å¯ä»¥ä½¿ç”¨ <code>VSCODE</code> å¸¦çš„ <code>Redis</code> æ’ä»¶ï¼š</p>
<p><img src="p3-juejin.byteimg.comtos-cn-i-k3u1fbpfcpc182110d5bb74431a19d3336ccd4e0c7~tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp?" alt="image.png" loading="lazy" class="medium-zoom-image"></p>
<p>ç‚¹å‡»é…ç½® <code>Redis</code> å‚æ•°ç›´è¿æœåŠ¡ï¼š</p>
<p><img src="p9-juejin.byteimg.comtos-cn-i-k3u1fbpfcpd07d3569d64847c8823dc79c3a0fe479~tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp?" alt="image.png" loading="lazy" class="medium-zoom-image"></p>
<p>è¾“å…¥ä»¥ä¸‹å‘½ä»¤å³å¯è·å–å­˜å‚¨çš„ <code>token</code> å†…å®¹ï¼š</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$ </span><span class="bash">GET APP_TOKEN_CACHE_KEY</span>
</code></pre>
<p><img src="p3-juejin.byteimg.comtos-cn-i-k3u1fbpfcp9033d365c8cd4fc59169d1f472c913f0~tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp?" alt="image.png" loading="lazy" class="medium-zoom-image"></p>
<p>åœ¨å¯¹æ¥å®Œæ¯• Redis ä¹‹åï¼Œå³ä½¿é›†ç¾¤éƒ¨ç½²æœåŠ¡ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„ç¼“å­˜ï¼Œä¹Ÿä¸æ‹…å¿ƒé‡å¯æœåŠ¡ä¹‹åç¼“å­˜æ•°æ®ä¸¢å¤±çš„æƒ…å†µã€‚</p>
<blockquote>
<p><code>Redis</code> çš„ç¤ºä¾‹ä»£ç å·²ä¸Šä¼  <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fboty-design%2Fgateway%2Ftree%2Fdemo%2Fv7" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/boty-design/gateway/tree/demo/v7" ref="nofollow noopener noreferrer">demo/v7</a>ï¼Œéœ€è¦çš„åŒå­¦è‡ªå–ã€‚</p>
</blockquote>
<h2 data-id="heading-5">å†™åœ¨æœ€å</h2>
<p>æœ¬ç« çš„å†…å®¹æ˜¯åç«¯ä¸šåŠ¡ <code>CURD</code> ä¸­æœ€é‡è¦çš„ä¸€å— =&gt; <strong>æ•°æ®åº“ç›¸å…³çš„å†…å®¹</strong>ï¼Œä»‹ç»äº†å¦‚ä½•åŸºäº <code>TypeORM</code> å°è£…æ•°æ®åº“æ–¹æ³•ä»¥åŠä½¿ç”¨æ–¹æ³•ï¼Œä½¿ç”¨ <code>user</code> è¿›è¡Œç®€å•çš„æ–°å¢ <code>demo</code> æ¼”ç¤ºï¼Œæ›´å¤š <code>TypeORM</code> ä¸æ•°æ®åº“çš„ä½¿ç”¨æ–¹æ³•åœ¨åé¢çš„ä¸šåŠ¡å¼€å‘ä»£ç ä¸­ä¼šç»“åˆå®ä¾‹ä»‹ç»ã€‚</p>
<p>å¦å¤–å¯¹ <code>Redis</code> çš„ä½¿ç”¨ä¹Ÿåšäº†éƒ¨åˆ†ä»‹ç»ï¼Œä¸»è¦æ˜¯åˆ©ç”¨äº† <code>cache-manager</code> æä¾›çš„åŠŸèƒ½ï¼Œå¦‚æœæœ‰å…´è¶£çš„è¯å¯ä»¥ä½¿ç”¨ <code>redis</code> åº“æŒ‰ç…§å°è£…æ•°æ®åº“çš„æ–¹å¼è‡ªå·±å°è£…å¯¹åº”çš„æ¨¡å—ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨ <code>Service</code> å°è£…ä¸€å¥—ç¼“å­˜çš„ <code>API</code> ä¹Ÿè¡Œã€‚</p>
<p>å¯¹äºæ­¤ç±»å·¥å…·çš„å°è£…ä»¥åŠä½¿ç”¨çš„æ–¹æ³•éå¸¸å¤šï¼Œçœ‹è‡ªå·±çš„éœ€æ±‚ä»¥åŠå–œå¥½å¼€å‘å³å¯ï¼Œä½†æ˜¯åœ¨åŸºç¡€å»ºè®¾ä¸­ä¸€å®šè¦åˆ‡è®°ï¼Œå¦‚æœå‡ºç°å¤šç§åº•å±‚æ•°æ®ã€å·¥å…·æ¥æºï¼Œä¸€å®šè¦åœ¨é€‚é…å±‚æŠ¹å¹³å·®å¼‚åŒ–ï¼Œå¯¹å¤–æä¾›çš„ <code>API</code> è°ƒç”¨ä¿è¯ä¸€è‡´æ€§ã€‚</p>
<p>å¯ä»¥å‚è€ƒä¸€ä¸‹æˆ‘ä¹‹å‰çš„åšå®¢<a href="https://juejin.cn/post/6854573211594522631" target="_blank" title="https://juejin.cn/post/6854573211594522631">é¡¹ç›®å®æˆ˜|ç¼“å­˜å¤„ç†</a>ï¼Œå¯¹äºå‰ç«¯çš„ <code>Cookie</code>ã€<code>Storage</code>ã€<code>indexDb</code> ç­‰å¤šç§ç¼“å­˜æ•°æ®æºéƒ½åšäº†é€‚é…æŠ¹å¹³åº•å±‚æ¥å£å·®å¼‚åŒ–çš„å¤„ç†ï¼Œä¸šåŠ¡åŒå­¦åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­æ›¿æ¢æ•°æ®æºéå¸¸ç®€ä¾¿ï¼Œå­¦ä¹ ä¸å¼€å‘æˆæœ¬é™ä½å¾ˆå¤šã€‚</p>
<p>å¦‚æœä½ æœ‰ä»€ä¹ˆç–‘é—®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæå‡ºï¼Œæˆ–è€…åŠ ç¾¤æ²Ÿé€šã€‚ ğŸ‘</p></div>
    </body>
    </html>