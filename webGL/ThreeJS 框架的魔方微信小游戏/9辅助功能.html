<!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title></title>
    </head>
    <body>
    <div class="markdown-body"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre>code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote>p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre>code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h1 data-id="heading-0">辅助功能</h1>
<h2 data-id="heading-1">前言</h2>
<p>在这一章中你将学到以下知识点：</p>
<ol>
<li>实现魔方小游戏各项辅助功能；</li>
<li>魔方状态的矩阵表示；</li>
<li>ThreeJS 框架中<code>Object3D</code>对象<code>matrix</code>属性含义及应用；</li>
<li>ThreeJS 框架中<code>Object3D</code>对象<code>matrix</code>属性和<code>matrixWorld</code>属性的差异；</li>
<li>ThreeJS 框架中<code>Scene</code>对象删除元素；</li>
<li>ThreeJS 框架中<code>CanvasTexture</code>对象和<code>Texture</code>对象的联系及区别。</li>
</ol>
<h2 data-id="heading-2">概述</h2>
<p>可以说目前我们已经完成这个魔方小游戏的主要功能，还剩下一些辅助功能，比如<code>重置</code>、<code>打乱</code>、<code>存档</code>、<code>读取</code>等功能；</p>
<p><img src="p1-jj.byteimg.comtos-cn-i-t2oaga2asxgold-user-assets20181251677d2d926f320fe~tplv-t2oaga2asx-zoom-in-crop-mark3024000.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>示例代码在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FnewbieYoung%2FThreejs_rubik%2Ftree%2Fmaster%2Flesson%2Fdemo7" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/newbieYoung/Threejs_rubik/tree/master/lesson/demo7" ref="nofollow noopener noreferrer">Threejs_rubik</a> 项目中；</p>
<p><img src="p1-jj.byteimg.comtos-cn-i-t2oaga2asxgold-user-assets20181251677d8cc71d0f898~tplv-t2oaga2asx-zoom-in-crop-mark3024000.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>之所以会加这些辅助功能是因为有些魔方还原算法是一步步达成目标的，比如初学者常用的<code>层先法</code>；</p>
<p><img src="p1-jj.byteimg.comtos-cn-i-t2oaga2asxgold-user-assets2018123167734faa00bbaeb~tplv-t2oaga2asx-zoom-in-crop-mark3024000.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>在学习过程中很难一蹴而就，其中的每一步从了解到熟练都需要重复很多次，因此基于这种一开始不能完整还原但是又需要重复训练的情况，加入了这些辅助功能。</p>
<h2 data-id="heading-3">实现</h2>
<p>在<code>正反视图</code>那章我们处理过控制条 UI 元素，在这里可以采用同样的方法处理<code>重置按钮</code>、<code>打乱按钮</code>、<code>存档按钮</code>、<code>读取按钮</code>；</p>
<h3 data-id="heading-4">1. 绘制 UI 元素</h3>
<p>以重置按钮举例来说：</p>
<p>重置按钮素材图片如下：</p>
<p><img src="p1-jj.byteimg.comtos-cn-i-t2oaga2asxgold-user-assets2018123167735ac432a075b~tplv-t2oaga2asx-zoom-in-crop-mark3024000.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>把图片素材统一存放到<code>images</code>目录中，并在<code>object</code>目录中新增<code>ResetBtn.js</code>；</p>
<p><img src="p1-jj.byteimg.comtos-cn-i-t2oaga2asxgold-user-assets20181231677375763b8411a~tplv-t2oaga2asx-zoom-in-crop-mark3024000.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>完整代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../threejs/three.js'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResetBtn</span> {

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">main</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span> = main;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isActive</span> = <span class="hljs-literal">false</span>;
    
        <span class="hljs-keyword">var</span> self = <span class="hljs-variable language_">this</span>;
        <span class="hljs-comment">//实际尺寸</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">realWidth</span> = <span class="hljs-number">64</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">realHeight</span> = <span class="hljs-number">64</span>;
    
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">radio</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">originWidth</span> / <span class="hljs-number">750</span>;
    
        <span class="hljs-comment">//逻辑尺寸</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">realWidth</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">radio</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span>;
    
        <span class="hljs-comment">//屏幕尺寸</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenRect</span> = {
            <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">uiRadio</span>,
            <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">uiRadio</span>
        }
    
        <span class="hljs-comment">//加载图片</span>
        <span class="hljs-keyword">var</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">TextureLoader</span>();
        loader.<span class="hljs-title function_">load</span>(<span class="hljs-string">'images/reset-btn.png'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">texture</span>) {
            <span class="hljs-keyword">var</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PlaneBufferGeometry</span>(self.<span class="hljs-property">width</span>, self.<span class="hljs-property">height</span>);
            <span class="hljs-keyword">var</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">map</span>: texture, <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span> });
            self.<span class="hljs-property">plane</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, material);
            self.<span class="hljs-property">plane</span>.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
            self.<span class="hljs-property">main</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">add</span>(self.<span class="hljs-property">plane</span>)
            self.<span class="hljs-title function_">defaultPosition</span>();
        }, <span class="hljs-keyword">function</span> (<span class="hljs-params">xhr</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>((xhr.<span class="hljs-property">loaded</span> / xhr.<span class="hljs-property">total</span> * <span class="hljs-number">100</span>) + <span class="hljs-string">'% loaded'</span>);
        }, <span class="hljs-keyword">function</span> (<span class="hljs-params">xhr</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'An error happened'</span>);
        });
    }
}
</code></pre>
<p><code>实际尺寸</code>可以由图片素材宽度决定；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* ResetBtn.js 第11行至第12行 */</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">realWidth</span> = <span class="hljs-number">64</span>;
<span class="hljs-variable language_">this</span>.<span class="hljs-property">realHeight</span> = <span class="hljs-number">64</span>;
</code></pre>
<p><code>逻辑尺寸</code>等于<code>实际尺寸</code>乘以缩放比率；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* ResetBtn.js 第17行至第18行 */</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">realWidth</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">radio</span>;
<span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span>;
</code></pre>
<p><code>缩放比率</code>则等于 UI 元素所在平面宽度除以设计稿页面宽度；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* ResetBtn.js 第14行 */</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">radio</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">originWidth</span> / <span class="hljs-number">750</span>;
</code></pre>
<p>重置按钮的屏幕尺寸计算和控制条不一样，控制条可以明确的知道投影到屏幕上时应该是完全铺满屏幕的，那么就可以确定控制条屏幕尺寸的宽度，然后根据宽高等比缩放的原则可以求出控制条屏幕尺寸的高度；</p>
<p>但是重置按钮并不能确定投影到屏幕上的宽高，此时可以根据控制条的屏幕尺寸计算投影缩放比率；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* main.js 第114行 */</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiRadio</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">originWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
</code></pre>
<p>然后保证所有 UI 元素都遵循同一缩放比率即可。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* main.js 第21行至第24行 */</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">screenRect</span> = {
    <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">uiRadio</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">uiRadio</span>
}
</code></pre>
<p>最后根据图片路径加载图片，在加载成功回调函数中创建重置按钮并加入到场景中即可，在<code>defaultPosition</code>函数中定义默认位置。</p>
<blockquote>
<p>其它 UI 元素也类似，就不一一赘述了。</p>
</blockquote>
<p>各种 UI 元素定义完成之后在需要在<code>main.js</code>中引入；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">ResetBtn</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'object/ResetBtn.js'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">DisorganizeBtn</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'object/DisorganizeBtn.js'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">SaveBtn</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'object/SaveBtn.js'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">RestoreBtn</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'object/RestoreBtn.js'</span>
</code></pre>
<p>然后在<code>initObject</code>函数中统一创建即可。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//重置按钮</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">resetBtn</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResetBtn</span>(<span class="hljs-variable language_">this</span>);
<span class="hljs-comment">//混乱按钮</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">disorganizeBtn</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DisorganizeBtn</span>(<span class="hljs-variable language_">this</span>);
<span class="hljs-comment">//保存按钮</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">saveBtn</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SaveBtn</span>(<span class="hljs-variable language_">this</span>);
<span class="hljs-comment">//还原按钮</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">restoreBtn</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestoreBtn</span>(<span class="hljs-variable language_">this</span>);
</code></pre>
<h3 data-id="heading-5">2. 重置魔方</h3>
<p>由于经过一系列打乱动画、转动魔方、转动视图、调整正反视图区域大小操作后，魔方的位置和开始的时候已经有了很大差别；</p>
<p>而重置魔方操作只需要把魔方还原成每个面颜色一致的状态，并不需要把正反视图区域大小也还原为初始状态；</p>
<p>这就要求有些变换需要还原，比如打乱动画、转动魔方、转动视图；而有些变换不需要还原，比如调整正反视图区域大小；</p>
<p>在前边的实现过程中我们既没有记录做了哪些变换操作，又没有对这些变换操作进行区分，粗一看起来实现重置魔方功能略微有些复杂，要想简单处理貌似只有重新创建场景这个方法。</p>
<p>实际上基于 ThreeJS 框架提供的一些功能使得重置魔方位置比你想象的要简单；在<code>魔方转动</code>那一章曾提到过<code>Object3D</code>对象有一个<code>matrixWorld</code>属性保存了物体在世界坐标系变换矩阵，这个对象还有一个<code>matrix</code>属性保存了物体在其父元素坐标系中的变换矩阵（如果物体没有父元素那么<code>matrix</code>和<code>matrixWorld</code>相同）；</p>
<p>魔方小方块的父元素是<code>Group</code>对象，只需要对这些方块做<code>matrix</code>的逆矩阵的变换就可以让魔方小方块回到其相对于父元素的初始位置了；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* Rubik.js 第615行至第618行 */</span>
<span class="hljs-keyword">var</span> matrix = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cubes</span>[i].<span class="hljs-property">matrix</span>.<span class="hljs-title function_">clone</span>();
matrix.<span class="hljs-title function_">getInverse</span>(matrix);
<span class="hljs-keyword">var</span> cube = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cubes</span>[i];
cube.<span class="hljs-title function_">applyMatrix</span>(matrix);
</code></pre>
<p><code>matrix.clone()</code>会克隆当前矩阵创建一个新的矩阵，<code>matrix.getInverse(matrix)</code>会得到<code>matrix</code>的逆反矩阵，之后执行<code>cube.applyMatrix(matrix)</code>对小方块做逆反矩阵变换即可，效果如下：</p>
<p><img src="p1-jj.byteimg.comtos-cn-i-t2oaga2asxgold-user-assets2018124167781c3b4f7c415~tplv-t2oaga2asx-zoom-in-crop-mark3024000.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>你可能会问，27 个小方块变成 1 个这是还原操作吗？</p>
<p>主要是因为创建这 27 个小方块时默认其中心都在父元素自身坐标系的坐标原点，那么对所有小方块做逆反矩阵变换自然都会回到初始位置，看起来也就重叠在一起了；</p>
<p>从图中可以看到转动魔方和转动视图操作都被还原了，但是调整正反视图区域大小的操作并没有，刚好符合要求。</p>
<p>只需要把所有小方块中心重新设置为初始中心位置就可以解决重叠在一起的问题了，而小方块的初始中心位置以及对应<code>id</code>在魔方创建时就已经保存在<code>initStatus</code>数组中了；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* Rubik.js 第620行至第629行 */</span>
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-variable language_">this</span>.<span class="hljs-property">initStatus</span>.<span class="hljs-property">length</span>;j++){
    <span class="hljs-keyword">var</span> status = <span class="hljs-variable language_">this</span>.<span class="hljs-property">initStatus</span>[j];
    <span class="hljs-keyword">if</span> (cube.<span class="hljs-property">id</span> == status.<span class="hljs-property">cubeIndex</span>){
        cube.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> = status.<span class="hljs-property">x</span>;
        cube.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = status.<span class="hljs-property">y</span>;
        cube.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = status.<span class="hljs-property">z</span>;
        cube.<span class="hljs-property">cubeIndex</span> = cube.<span class="hljs-property">id</span>;
        <span class="hljs-keyword">continue</span>;
    }
}
</code></pre>
<p>遍历数组然后根据<code>id</code>属性还原即可。</p>
<p>完整代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* Rubik.js 第613行至第631行 */</span>
<span class="hljs-title function_">reset</span>(<span class="hljs-params"></span>){
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-variable language_">this</span>.<span class="hljs-property">cubes</span>.<span class="hljs-property">length</span>;i++){
        <span class="hljs-keyword">var</span> matrix = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cubes</span>[i].<span class="hljs-property">matrix</span>.<span class="hljs-title function_">clone</span>();
        matrix.<span class="hljs-title function_">getInverse</span>(matrix);
        <span class="hljs-keyword">var</span> cube = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cubes</span>[i];
        cube.<span class="hljs-title function_">applyMatrix</span>(matrix);
    
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-variable language_">this</span>.<span class="hljs-property">initStatus</span>.<span class="hljs-property">length</span>;j++){
            <span class="hljs-keyword">var</span> status = <span class="hljs-variable language_">this</span>.<span class="hljs-property">initStatus</span>[j];
            <span class="hljs-keyword">if</span> (cube.<span class="hljs-property">id</span> == status.<span class="hljs-property">cubeIndex</span>){
                cube.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> = status.<span class="hljs-property">x</span>;
                cube.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = status.<span class="hljs-property">y</span>;
                cube.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = status.<span class="hljs-property">z</span>;
                cube.<span class="hljs-property">cubeIndex</span> = cube.<span class="hljs-property">id</span>;
                <span class="hljs-keyword">break</span>;
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-6">3. 打乱魔方</h3>
<p>有重置功能自然需要对应的打乱功能，在<code>初始动画</code>那一章我们已经分析过怎么随机打乱一个魔方了，这里只需要把打乱魔方逻辑从初始动画函数<code>enterAnimation</code>中封装抽离出来即可。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* main.js 第303行至第305行 */</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">disorganizeRubik</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
    self.<span class="hljs-title function_">initEvent</span>();<span class="hljs-comment">//进场动画结束之后才能进行手动操作</span>
})

<span class="hljs-comment">/* main.js 第505行至第517行 */</span>
<span class="hljs-title function_">disorganizeRubik</span>(<span class="hljs-params">callback</span>){
    <span class="hljs-keyword">var</span> self = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">if</span>(!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRotating</span>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRotating</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">var</span> stepArr = <span class="hljs-variable language_">this</span>.<span class="hljs-property">frontRubik</span>.<span class="hljs-title function_">randomRotate</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">endRubik</span>.<span class="hljs-title function_">runMethodAtNo</span>(stepArr, <span class="hljs-number">0</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>){
            <span class="hljs-keyword">if</span> (callback){
                <span class="hljs-title function_">callback</span>();
            }
            self.<span class="hljs-title function_">resetRotateParams</span>();
        });
    }
}
</code></pre>
<h3 data-id="heading-7">4. 存储魔方</h3>
<p>重置和打乱功能只能保证不管能不能还原魔方都能回到魔方的初始状态，而存档和读取则能保证可以随时回到特定状态。</p>
<p><img src="p1-jj.byteimg.comtos-cn-i-t2oaga2asxgold-user-assets20181251677d55711456dc4~tplv-t2oaga2asx-zoom-in-crop-mark3024000.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>点击存档之后，按钮下方会出现一个不断旋转的小魔方，因此存储魔方可以采用克隆一个新魔方的方法，并把克隆得到的新魔方定位到特定位置。</p>
<p>在重置魔方功能的实现中我们已经知道所谓的魔方状态其实是由小方块位置决定的，而小方块的位置则是由其变换矩阵<code>matrix</code>决定的，也就是说魔方的状态其实就存储在小方块的变换矩阵中；</p>
<p>那么克隆魔方也就是复制该魔方小方块的变换矩阵了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* Rubik.js 第636行至第655行 */</span>
<span class="hljs-title function_">save</span>(<span class="hljs-params">rubik, position ,number</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">cubes</span>.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-keyword">var</span> matrix = rubik.<span class="hljs-property">cubes</span>[i].<span class="hljs-property">matrix</span>.<span class="hljs-title function_">clone</span>();
        <span class="hljs-keyword">var</span> selfMat = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cubes</span>[i].<span class="hljs-property">matrix</span>.<span class="hljs-title function_">clone</span>();
        selfMat = selfMat.<span class="hljs-title function_">getInverse</span>(selfMat);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cubes</span>[i].<span class="hljs-title function_">applyMatrix</span>(selfMat);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cubes</span>[i].<span class="hljs-title function_">applyMatrix</span>(matrix);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateCubeIndex</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cubes</span>);
    
    <span class="hljs-keyword">if</span> (position){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">group</span>.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> = position.<span class="hljs-property">x</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">group</span>.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = position.<span class="hljs-property">y</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">group</span>.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = position.<span class="hljs-property">z</span>;
    }
    
    <span class="hljs-keyword">if</span> (number!=<span class="hljs-literal">null</span>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">group</span>.<span class="hljs-property">scale</span>.<span class="hljs-title function_">set</span>(number, number, number);
    }
}
</code></pre>
<p>存储魔方函数<code>saveRubik</code>接收三个参数，分别是：</p>
<ul>
<li><code>rubik</code>表示克隆的样例魔方；</li>
<li><code>position</code>表示新魔方的中心点；</li>
<li><code>number</code>表示缩放倍数；</li>
</ul>
<p>遍历魔方中的小方块然后使其变换到克隆的样例魔方中小方块的位置，然后更新小方块索引；如果传入新的中心点和缩放倍数则需要设置中心以及进行缩放。</p>
<p>存储魔方状态函数<code>saveRubik</code>完整代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* main.js 第522行至第558行 */</span>
<span class="hljs-title function_">saveRubik</span>(<span class="hljs-params"></span>){
    wx.<span class="hljs-title function_">showLoading</span>({
        <span class="hljs-attr">title</span>: <span class="hljs-string">'存档中...'</span>,
        <span class="hljs-attr">mask</span>:<span class="hljs-literal">true</span>
    })
    
    <span class="hljs-keyword">var</span> bgCanvas = <span class="hljs-title function_">background</span>();
    <span class="hljs-keyword">var</span> radio = <span class="hljs-variable language_">this</span>.<span class="hljs-property">originWidth</span> / <span class="hljs-number">750</span>;
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubik</span>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubik</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicRubik</span>(<span class="hljs-variable language_">this</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubik</span>.<span class="hljs-title function_">model</span>();
    }
    <span class="hljs-keyword">var</span> tagPosition = <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveBtn</span>.<span class="hljs-title function_">getPosition</span>();
    tagPosition.<span class="hljs-property">y</span> -= <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveBtn</span>.<span class="hljs-property">height</span>/<span class="hljs-number">2</span>+<span class="hljs-number">15</span>;
    tagPosition.<span class="hljs-property">x</span> += (<span class="hljs-variable language_">this</span>.<span class="hljs-property">saveBtn</span>.<span class="hljs-property">width</span> - bgCanvas.<span class="hljs-property">width</span>) / <span class="hljs-number">2</span> * radio;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubik</span>.<span class="hljs-title function_">save</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">frontRubik</span>, tagPosition, <span class="hljs-number">0.05</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubik</span>.<span class="hljs-property">group</span>);
    
    <span class="hljs-comment">//添加灰色半透明背景</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubikBg</span>){
        <span class="hljs-keyword">var</span> bgWidth = bgCanvas.<span class="hljs-property">width</span> * radio;
        <span class="hljs-keyword">var</span> bgHeight = bgCanvas.<span class="hljs-property">height</span> * radio;
        <span class="hljs-keyword">var</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PlaneGeometry</span>(bgWidth, bgHeight);
        <span class="hljs-keyword">var</span> texture = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">CanvasTexture</span>(bgCanvas);
        <span class="hljs-keyword">var</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">map</span>: texture, <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span> });
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubikBg</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, material);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubikBg</span>.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> = tagPosition.<span class="hljs-property">x</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubikBg</span>.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = tagPosition.<span class="hljs-property">y</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubikBg</span>.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = tagPosition.<span class="hljs-property">z</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubikBg</span>);
    
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>){
        wx.<span class="hljs-title function_">hideLoading</span>()
    },<span class="hljs-number">500</span>)
}
</code></pre>
<p>在这个函数中需要几点需要注意的地方：</p>
<ul>
<li>
<p><code>wx.showLoading</code>和<code>wx.hideLoading</code>是为了防止过多且过快的点击存储按钮；</p>
</li>
<li>
<p>如果<code>标签魔方</code>和<code>圆角矩形半透明背景</code>已经存在了则不需要再次创建，只需要更新其状态就好了；</p>
</li>
<li>
<p><code>var bgCanvas = background()</code>是生成圆角矩形半透明背景；</p>
</li>
<li>
<p>在绘制<code>圆角矩形半透明背景</code>时使用了<code>CanvasTexture</code>对象，它其实继承自<code>Texture</code>对象；区别在于<code>CanvasTexture</code>对象只能使用<code>Canvas</code>元素作为素材且其<code>needsUpdate</code>属性默认为<code>true</code>，这样才能保证<code>Canvas</code>元素内容被完全加载了；</p>
</li>
<li>
<p><code>标签魔方</code>的中心位置可以由<code>存储按钮</code>的位置计算得到。</p>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> tagPosition = <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveBtn</span>.<span class="hljs-title function_">getPosition</span>();
tagPosition.<span class="hljs-property">y</span> -= <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveBtn</span>.<span class="hljs-property">height</span>/<span class="hljs-number">2</span>+<span class="hljs-number">15</span>;
tagPosition.<span class="hljs-property">x</span> += (<span class="hljs-variable language_">this</span>.<span class="hljs-property">saveBtn</span>.<span class="hljs-property">width</span> - bgCanvas.<span class="hljs-property">width</span>) / <span class="hljs-number">2</span> * radio;
</code></pre>
<h3 data-id="heading-8">5. 读取魔方</h3>
<p>读取魔方只需要让正视角魔方和反视角魔方都复制<code>标签魔方</code>就好了，另外还需要从场景中删除调<code>标签魔方</code>以及<code>背景</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* main.js 第563行至第575行 */</span>
<span class="hljs-title function_">restoreRubik</span>(<span class="hljs-params"></span>){
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubik</span>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">frontRubik</span>.<span class="hljs-title function_">save</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubik</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">endRubik</span>.<span class="hljs-title function_">save</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubik</span>);
    
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubik</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubik</span>.<span class="hljs-property">group</span>);
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubikBg</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubikBg</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-9">6. 事件处理</h3>
<p>点击<code>重置</code>、<code>打乱</code>、<code>存储</code>、<code>读取</code>等按钮都需要在触摸开始事件的回调函数<code>touchStart</code>中处理；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* main.js 第196行至第208行 */</span>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">resetBtn</span>.<span class="hljs-title function_">isHover</span>(touch) &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRotating</span>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">resetBtn</span>.<span class="hljs-title function_">enable</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resetRubik</span>();
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">disorganizeBtn</span>.<span class="hljs-title function_">isHover</span>(touch) &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRotating</span>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">disorganizeBtn</span>.<span class="hljs-title function_">enable</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">disorganizeRubik</span>();
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">saveBtn</span>.<span class="hljs-title function_">isHover</span>(touch) &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRotating</span>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveBtn</span>.<span class="hljs-title function_">enable</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveRubik</span>();
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">restoreBtn</span>.<span class="hljs-title function_">isHover</span>(touch) &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRotating</span>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">restoreBtn</span>.<span class="hljs-title function_">enable</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">restoreRubik</span>();
}
</code></pre>
<p>最后在触摸结束事件的回调函数<code>touchEnd</code>中重置它们的状态。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/* main.js 第251行至第254行 */</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">resetBtn</span>.<span class="hljs-title function_">disable</span>();
<span class="hljs-variable language_">this</span>.<span class="hljs-property">disorganizeBtn</span>.<span class="hljs-title function_">disable</span>();
<span class="hljs-variable language_">this</span>.<span class="hljs-property">saveBtn</span>.<span class="hljs-title function_">disable</span>();
<span class="hljs-variable language_">this</span>.<span class="hljs-property">restoreBtn</span>.<span class="hljs-title function_">disable</span>();
</code></pre>
<h2 data-id="heading-10">总结</h2>
<p>了解 ThreeJS 框架的各种对象的用法能帮助你熟悉这个框架，但是如果你想掌握这个框架估计得从掌握<code>Object3D</code>这个对象开始！</p></div>
    </body>
    </html>