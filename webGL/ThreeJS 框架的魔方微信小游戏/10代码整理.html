<!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title></title>
    </head>
    <body>
    <div class="markdown-body"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre>code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote>p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre>code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h1 data-id="heading-0">代码整理</h1>
<h2 data-id="heading-1">概述</h2>
<p>本来只凑了九小节，但是有小伙伴反馈代码写的很烂，而且自己在扩展<code>变阶</code>功能的时候感觉确实如此。</p>
<h2 data-id="heading-2">整理</h2>
<p>自我审视了一下代码，感觉主要问题在以下几点：</p>
<h3 data-id="heading-3">1、逻辑冗余</h3>
<p>简易三阶魔方的 27 个小方块是一样的，每个小方块存在六个面，那么只需要六个 Canvas 素材生成六种不同颜色的材质即可；</p>
<p>但是在实际代码中每创建一个方块就创建了六个 Canvas 素材生成了六种不同颜色的材质；</p>
<p>问题代码截图如下（注意红框中的部分）：</p>
<p><img src="p1-jj.byteimg.comtos-cn-i-t2oaga2asxgold-user-assets2019131680f82b91751986~tplv-t2oaga2asx-zoom-in-crop-mark3024000.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>优化后<code>Rubik.js</code>中的<code>SimpleCube</code>方法如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SimpleCube</span>(<span class="hljs-params">x, y, z, num, len, colors</span>) {
    <span class="hljs-comment">//魔方左上角坐标</span>
    <span class="hljs-keyword">var</span> leftUpX = x - num / <span class="hljs-number">2</span> * len;
    <span class="hljs-keyword">var</span> leftUpY = y + num / <span class="hljs-number">2</span> * len;
    <span class="hljs-keyword">var</span> leftUpZ = z + num / <span class="hljs-number">2</span> * len;
    
    <span class="hljs-comment">//根据颜色生成材质</span>
    <span class="hljs-keyword">var</span> materialArr = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-title class_">BasicParams</span>.<span class="hljs-property">colors</span>.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-keyword">var</span> texture = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Texture</span>(<span class="hljs-title function_">faces</span>(<span class="hljs-title class_">BasicParams</span>.<span class="hljs-property">colors</span>[i]));
        texture.<span class="hljs-property">needsUpdate</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">var</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshLambertMaterial</span>({ <span class="hljs-attr">map</span>: texture });
        materialArr.<span class="hljs-title function_">push</span>(material);
    }
    
    <span class="hljs-keyword">var</span> cubes = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; num; i++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; num * num; j++) {
            <span class="hljs-keyword">var</span> cubegeo = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BoxGeometry</span>(len, len, len);
            <span class="hljs-keyword">var</span> cube = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(cubegeo, materialArr);
            
            <span class="hljs-comment">//依次计算各个小方块中心点坐标</span>
            cube.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> = (leftUpX + len / <span class="hljs-number">2</span>) + (j % num) * len;
            cube.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = (leftUpY - len / <span class="hljs-number">2</span>) - <span class="hljs-built_in">parseInt</span>(j / num) * len;
            cube.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = (leftUpZ - len / <span class="hljs-number">2</span>) - i * len;
            cubes.<span class="hljs-title function_">push</span>(cube);
        }
    }
    <span class="hljs-keyword">return</span> cubes;
}
</code></pre>
<p>优化点在于在创建小方块之前就根据颜色创建 Canvas 素材并生成好需要的材质保存起来，后续只是对这六种材质的复用。</p>
<h3 data-id="heading-4">2、逻辑重复</h3>
<p>代码中的各个按钮对象除了素材图片及其尺寸、空间位置不一样以外，其它都大同小异，但是我们并没有对这些相似逻辑进行封装；</p>
<p>其实可以把重复逻辑抽象出来，封装成<code>UIComponent</code>对象，用来处理小游戏中的自定义UI组件；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../threejs/three.js'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UIComponentt</span> {

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {}
    
    <span class="hljs-comment">/**
     * 加载纹理背景
     */</span>
    <span class="hljs-title function_">loadBackground</span>(<span class="hljs-params"></span>){}
    
    <span class="hljs-comment">/**
     * 在场景中显示和隐藏
     */</span>
    <span class="hljs-title function_">showInScene</span>(<span class="hljs-params"></span>){}
    <span class="hljs-title function_">hideInScene</span>(<span class="hljs-params"></span>){}
    
    <span class="hljs-comment">/**
     * 设置尺寸
     */</span>
    <span class="hljs-title function_">setSize</span>(<span class="hljs-params"></span>){}
    
    <span class="hljs-comment">/**
     * 设置位置
     */</span>
    <span class="hljs-title function_">setPosition</span>(<span class="hljs-params"></span>) {}
    
    <span class="hljs-comment">/**
     * 获取位置
     */</span>
    <span class="hljs-title function_">getPosition</span>(<span class="hljs-params"></span>) {}
    
    <span class="hljs-comment">/**
     * 判断是否在范围内
     */</span>
    <span class="hljs-title function_">isHover</span>(<span class="hljs-params"></span>) {}
    
    <span class="hljs-comment">/**
     * 状态切换
     */</span>
    <span class="hljs-title function_">enable</span>(<span class="hljs-params"></span>) {}
    <span class="hljs-title function_">disable</span>(<span class="hljs-params"></span>) {}
}
</code></pre>
<p><code>构造</code>函数接受主游戏逻辑对象中的一些和 UI 相关的参数；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">constructor</span>(<span class="hljs-params">main</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span> = main;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isActive</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">radio</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">originWidth</span> / <span class="hljs-number">750</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiRadio</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">uiRadio</span>;
}
</code></pre>
<p><code>设置尺寸</code>函数接受实际尺寸，然后根据 UI 缩放比率等参数，推算出逻辑尺寸和屏幕尺寸；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">setSize</span>(<span class="hljs-params">width,height</span>){
    <span class="hljs-comment">//实际尺寸</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">realWidth</span> = width;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">realHeight</span> = height;
    
    <span class="hljs-comment">//逻辑尺寸</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">realWidth</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">radio</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">realHeight</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">radio</span>;
    
    <span class="hljs-comment">//屏幕尺寸</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenRect</span> = {
        <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">uiRadio</span>,
        <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">uiRadio</span>
    }
}
</code></pre>
<p><code>获取位置</code>函数会返回 UI 元素对象的中心点在空间中的坐标；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">getPosition</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">plane</span>.<span class="hljs-property">position</span>.<span class="hljs-title function_">clone</span>();
}
</code></pre>
<p><code>激活状态切换</code>函数会切换状态属性<code>isActive</code>的值；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">enable</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isActive</span> = <span class="hljs-literal">true</span>;
}
<span class="hljs-title function_">disable</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isActive</span> = <span class="hljs-literal">false</span>;
}
</code></pre>
<p><code>设置位置</code>函数接受 UI 元素在 3D 空间坐标系中的坐标值，然后更新其在 3D 空间以及投影到屏幕的位置；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">setPosition</span>(<span class="hljs-params">x,y,z</span>) {
    <span class="hljs-keyword">if</span> (x) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">plane</span>.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> = x;
    }
    <span class="hljs-keyword">if</span> (y) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">plane</span>.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = y;
    }
    <span class="hljs-keyword">if</span> (z) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">plane</span>.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = z;
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenRect</span>.<span class="hljs-property">left</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">originWidth</span> / <span class="hljs-number">2</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">plane</span>.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span> / <span class="hljs-number">2</span>) / <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">uiRadio</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenRect</span>.<span class="hljs-property">top</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">originHeight</span> / <span class="hljs-number">2</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">plane</span>.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>) / <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">uiRadio</span>;
}
</code></pre>
<p><code>判断是否在 UI 元素范围内</code>函数接受触摸点屏幕坐标，然后根据 UI 元素的屏幕位置以及屏幕尺寸判断；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">isHover</span>(<span class="hljs-params">touch</span>) {
    <span class="hljs-keyword">var</span> isHover = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (touch.<span class="hljs-property">clientY</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenRect</span>.<span class="hljs-property">top</span> &amp;&amp; touch.<span class="hljs-property">clientY</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenRect</span>.<span class="hljs-property">top</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenRect</span>.<span class="hljs-property">height</span> &amp;&amp; touch.<span class="hljs-property">clientX</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenRect</span>.<span class="hljs-property">left</span> &amp;&amp; touch.<span class="hljs-property">clientX</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenRect</span>.<span class="hljs-property">left</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenRect</span>.<span class="hljs-property">width</span>) {
      isHover = <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> isHover;
}
</code></pre>
<p><code>显示状态切换</code>函数会把 UI 对象加入到场景中或者将其从场景中删除；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">showInScene</span>(<span class="hljs-params"></span>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">plane</span>);
}
<span class="hljs-title function_">hideInScene</span>(<span class="hljs-params"></span>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">plane</span>);
}
</code></pre>
<p><code>加载纹理背景</code>函数接受图片素材的 url 路径以及回调方法，使用纹理加载器加载图片素材，然后创建平面对象用于绘制 UI 元素；当加载完成且绘制成功之后再执行回调函数；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">loadBackground</span>(<span class="hljs-params">url, callback</span>){
    <span class="hljs-keyword">var</span> self = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">var</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">TextureLoader</span>();
    loader.<span class="hljs-title function_">load</span>(url, <span class="hljs-keyword">function</span> (<span class="hljs-params">texture</span>) {
        <span class="hljs-keyword">var</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PlaneBufferGeometry</span>(self.<span class="hljs-property">width</span>, self.<span class="hljs-property">height</span>);
        <span class="hljs-keyword">var</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">map</span>: texture, <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span> });
        self.<span class="hljs-property">plane</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, material);
        self.<span class="hljs-property">plane</span>.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        self.<span class="hljs-title function_">showInScene</span>();
        <span class="hljs-keyword">if</span> (callback) {
            <span class="hljs-title function_">callback</span>();
        }
    }, <span class="hljs-keyword">function</span> (<span class="hljs-params">xhr</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>((xhr.<span class="hljs-property">loaded</span> / xhr.<span class="hljs-property">total</span> * <span class="hljs-number">100</span>) + <span class="hljs-string">'% loaded'</span>);
    }, <span class="hljs-keyword">function</span> (<span class="hljs-params">xhr</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'An error happened'</span>);
    });
}
</code></pre>
<p>有了<code>UIComponent</code>对象，我们再创建 UI 元素时，就只需要在其构造函数中设置尺寸以及加载图片素材即可；以还原按钮<code>ResetBtn</code>对象为例，代码可以优化如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../threejs/three.js'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">UIComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./UIComponent.js'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResetBtn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIComponent</span> {

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">main</span>) {
        <span class="hljs-variable language_">super</span>(main);
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setSize</span>(<span class="hljs-number">64</span>, <span class="hljs-number">64</span>);
    
        <span class="hljs-keyword">var</span> self = <span class="hljs-variable language_">this</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadBackground</span>(<span class="hljs-string">'images/reset-btn.jpg'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
            self.<span class="hljs-title function_">defaultPosition</span>();
        });
    }

    <span class="hljs-comment">/**
     * 默认位置
     */</span>
    <span class="hljs-title function_">defaultPosition</span>(<span class="hljs-params"></span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">plane</span>.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> = -<span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">originWidth</span> / <span class="hljs-number">2</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span> / <span class="hljs-number">2</span> + <span class="hljs-number">45</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">radio</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">plane</span>.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">originHeight</span> / <span class="hljs-number">2</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span> * <span class="hljs-number">3</span> / <span class="hljs-number">2</span> - <span class="hljs-number">35</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">radio</span>;
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenRect</span>.<span class="hljs-property">left</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">originWidth</span> / <span class="hljs-number">2</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">plane</span>.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span> / <span class="hljs-number">2</span>) / <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">uiRadio</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenRect</span>.<span class="hljs-property">top</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">originHeight</span> / <span class="hljs-number">2</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">plane</span>.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>) / <span class="hljs-variable language_">this</span>.<span class="hljs-property">main</span>.<span class="hljs-property">uiRadio</span>;
    }
}
</code></pre>
<h3 data-id="heading-5">3、逻辑混乱</h3>
<p>没有整理代码之前在游戏主逻辑文件<code>main.js</code>中存在两个方法，分别是创建圆角矩形的<code>radiusRect</code>方法和生成半透明背景的<code>background</code>，这两个和 UI 相关的方法出现在游戏主逻辑文件中很明显有点混乱了；</p>
<p><img src="p1-jj.byteimg.comtos-cn-i-t2oaga2asxgold-user-assets20191316813eb9f73728b7~tplv-t2oaga2asx-zoom-in-crop-mark3024000.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>我们需要把它们封装到<code>UIComponnet</code>对象中才算合理，而且状态魔方的灰色半透明圆角矩形背景本身就算是 UI 相关元素；</p>
<p>之前<code>UIComponnet</code>对象只支持加载图片素材生成 UI 元素，这里新增一个<code>loadStyle</code>方法，让其可以根据简单的<code>类 CSS 样式</code>规则生成 UI 元素；</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">loadStyle</span>(<span class="hljs-params">uiParams</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span> = uiParams;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">pixelRatio</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">pixelRatio</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">pixelRatio</span> : <span class="hljs-number">1</span>;<span class="hljs-comment">//设备像素比默认为1</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">width</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">height</span>);
    <span class="hljs-keyword">var</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PlaneGeometry</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span>);
    <span class="hljs-keyword">var</span> texture = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">CanvasTexture</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_background</span>());
    <span class="hljs-keyword">var</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">map</span>: texture, <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span> });
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">plane</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, material);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showInScene</span>();
}
</code></pre>
<p><code>uiParams</code>目前支持以下属性：</p>
<ul>
<li>宽度<code>width</code>；</li>
<li>高度<code>height</code>；</li>
<li>圆角<code>radius</code>；</li>
<li>背景颜色<code>backgroundColor</code>；</li>
<li>边框<code>borderTop</code>、<code>borderRight</code>、<code>borderBottom</code>、<code>borderLeft</code>、<code>borderColor</code>；</li>
<li>文字<code>fontSize</code>、<code>fontColor</code>、<code>fontFamily</code>、<code>fontWeight</code>、<code>content</code>；</li>
<li>设备像素比<code>pixelRatio</code>（主要用于处理 Canvas 文字模糊问题）。</li>
</ul>
<p><code>loadStyle</code>和<code>loadBackground</code>的主要区域在于前者在<code>_background</code>方法中根据类 CSS 样式规则生成 Canvas 素材充当 UI 元素的背景，后者直接加载图片素材充当 UI 元素的背景；</p>
<p><code>_background</code>方法具体实现如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">_background</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">var</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
    canvas.<span class="hljs-property">width</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">realWidth</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">pixelRatio</span>;
    canvas.<span class="hljs-property">height</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">realHeight</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">pixelRatio</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_radiusRect</span>(canvas, <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">radius</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">pixelRatio</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">backgroundColor</span>);
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">radius</span>) {<span class="hljs-comment">//暂时不支持圆角边框</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_border</span>(canvas, <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">borderTop</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">pixelRatio</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">borderRight</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">pixelRatio</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">borderBottom</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">pixelRatio</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">borderLeft</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">pixelRatio</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">borderColor</span>)
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">content</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_text</span>(canvas, <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">fontSize</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">pixelRatio</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">fontFamily</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">fontColor</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">content</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiParams</span>.<span class="hljs-property">fontWeight</span>);
    }
    <span class="hljs-keyword">return</span> canvas;
}
</code></pre>
<p><code>UIComponent</code>对象中的<code>_background</code>方法也就是未优化之前在<code>main.js</code>中的<code>background</code>方法了；在此方法中先创建 Canvas 元素然后依次执行<code>_radiusRect</code>、<code>_border</code>、<code>_text</code>等方法处理对应的类 CSS 样式规则；</p>
<p>而<code>_radiusRect</code>方法则是未优化之前在<code>main.js</code>中的<code>radiusRect</code>方法；</p>
<p>这些方法中都是些 Canvas API 的使用，比如使用 textAlign 属性可以实现 Canvas 绘制文字水平居中；使用 textBaseline 属性可以实现 Canvas 绘制文字垂直居中等。</p>
<p>扩展<code>UIComponent</code>对象的能力之后，就可以把<code>main.js</code>中的存储魔方<code>saveRubik</code>方法中生成状态魔方半透明背景的代码封装成直接使用<code>UIComponent</code>对象实现；</p>
<p><img src="p1-jj.byteimg.comtos-cn-i-t2oaga2asxgold-user-assets20191316813f8b5029ecb0~tplv-t2oaga2asx-zoom-in-crop-mark3024000.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>图片中红色部分为未优化代码，绿色部分为优化后的代码；</p>
<p>优化后<code>main.js</code>的<code>saveRubik</code>方法完整代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">saveRubik</span>(<span class="hljs-params"></span>){
    wx.<span class="hljs-title function_">showLoading</span>({
      <span class="hljs-attr">title</span>: <span class="hljs-string">'存档中...'</span>,
      <span class="hljs-attr">mask</span>:<span class="hljs-literal">true</span>
    })

    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubik</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubik</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicRubik</span>(<span class="hljs-variable language_">this</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubik</span>.<span class="hljs-title function_">model</span>();
    }
    <span class="hljs-keyword">var</span> tagPosition = <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveBtn</span>.<span class="hljs-title function_">getPosition</span>();
    tagPosition.<span class="hljs-property">y</span> -= <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveBtn</span>.<span class="hljs-property">height</span> / <span class="hljs-number">2</span> + <span class="hljs-number">15</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubik</span>.<span class="hljs-title function_">save</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">frontRubik</span>, tagPosition, <span class="hljs-number">0.05</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubik</span>.<span class="hljs-property">group</span>);

    <span class="hljs-comment">//添加灰色半透明背景</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubikBg</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubikBg</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIComponent</span>(<span class="hljs-variable language_">this</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubikBg</span>.<span class="hljs-title function_">loadStyle</span>({
        <span class="hljs-attr">width</span>: <span class="hljs-number">64</span>,
        <span class="hljs-attr">height</span>: <span class="hljs-number">64</span>,
        <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'rgba(0,0,0,0.1)'</span>,
        <span class="hljs-attr">radius</span>: <span class="hljs-number">8</span>
      });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubikBg</span>.<span class="hljs-title function_">showInScene</span>();
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tagRubikBg</span>.<span class="hljs-title function_">setPosition</span>(tagPosition.<span class="hljs-property">x</span>, tagPosition.<span class="hljs-property">y</span>, tagPosition.<span class="hljs-property">z</span>);

    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>){
      wx.<span class="hljs-title function_">hideLoading</span>()
    },<span class="hljs-number">500</span>)
}
</code></pre>
<h3 data-id="heading-6">4、逻辑晦涩</h3>
<p>另外在<code>魔方转动分析</code>那里的逻辑有点晦涩，转动方向使用了<code>1.1</code>、<code>2.3</code>这种不太容易理解的数字常量区分方法；不过对于这个问题目前我并没有想到太好的优化方案，大家可以思考一下。</p>
<h2 data-id="heading-7">总结</h2>
<p>整理之后的完整代码在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FnewbieYoung%2FThreejs_rubik%2Ftree%2Fmaster%2Flesson%2Fdemo8" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/newbieYoung/Threejs_rubik/tree/master/lesson/demo8" ref="nofollow noopener noreferrer">Threejs_rubik</a> 项目中；</p>
<p><img src="p1-jj.byteimg.comtos-cn-i-t2oaga2asxgold-user-assets20191316814156f4ab9dbb~tplv-t2oaga2asx-zoom-in-crop-mark3024000.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>因为水平有限，代码中或大或小的问题，肯定不仅仅只有上边那些，大家可以自由发挥，随意吐槽。</p></div>
    </body>
    </html>